<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V-Transer Panel</title>
  <link rel="stylesheet" href="sidepanel.css" />
</head>
<body>
  <div id="panel">

    <!-- ✅ LEFT: main column (center screen + bottom bar fixed) -->
    <div class="main-col">
      <!-- center screens -->
      <div class="view-container">
        <div class="content-flipper">

          <!-- CHAT VIEW -->
          <div id="chat-content" class="content-view hidden">
            <div class="chat-topbar">
              <button
                id="chatConversationsToggle"
                class="chat-conv-toggle-btn"
                type="button"
                title="Lịch sử trò chuyện"
                aria-label="Lịch sử trò chuyện"
                aria-expanded="false"
                aria-controls="chatConversationsPanel"
              >
                <span class="chat-conv-toggle-icon" aria-hidden="true">☰</span>
              </button>
            </div>

            <div id="chatConversationsPanel" class="chat-conv-panel hidden" aria-hidden="true">
              <div class="chat-conv-panel-head">
                <h3 class="chat-conv-panel-title">Lịch sử trò chuyện</h3>
                <button id="chatConversationsNewBtn" class="chat-conv-new-btn" type="button">
                  Cuộc trò chuyện mới
                </button>
              </div>
              <div id="chatConversationsEmpty" class="chat-conv-empty hidden">Chưa có cuộc trò chuyện.</div>
              <div id="chatConversationsList" class="chat-conv-list" role="list"></div>
            </div>
            <div class="chat-history-area"></div>

            <div class="chat-input-area">
              <div id="chatRagSelectionBar" class="chat-rag-selection-bar hidden"></div>

              <div class="textarea-wrapper">
                <textarea placeholder="Hãy viết gì đó"></textarea>
                <div class="chat-input-controls-row">
                  <div class="chat-input-tools-row">
                    <button
                      id="chatChipRag"
                      class="chip-button"
                      type="button"
                      title="Truy xuất thông tin"
                      aria-label="Truy xuất thông tin"
                      data-rag-picker-trigger="1"
                    >
                      <img src="icons/database.svg" alt="" class="input-btn-icon" />
                    </button>
                    <button
                      id="chatChipR1"
                      class="chip-button"
                      type="button"
                      title="Suy luận (R1)"
                      aria-label="Suy luận (R1)"
                    >
                      <img src="icons/brain.svg" alt="" class="input-btn-icon" />
                    </button>
                  </div>
                  <button id="icon-btn-send" class="icon-btn-simple" title="send" type="button"></button>
                </div>
              </div>
            </div>
          </div>

          <!-- TRANSCRIPT VIEW -->
          <div id="transcript-content" class="content-view">
            <div class="transcript-box">
              <div class="transcript-header">
                <h3>Nội dung chi tiết</h3>
                <p class="transcript-url">Website: (chưa bắt đầu)</p>
              </div>

              <div class="transcript-body">
                <div class="placeholder-text transcript-placeholder">
                  Nhấn nút bên dưới để bắt đầu.
                </div>
              </div>

              <div class="transcript-live-footer">
                <span>Live</span>
              </div>
            </div>

            <div class="transcript-controls-row">
              <button class="transcript-btn1 start" type="button" aria-label="Start/Stop"></button>
            </div>

            <div class="transcript-actions-row">
              <button id="btn-subtitle" class="transcript-btn" type="button">
                <img src="icons/phude.svg" alt="" class="action-btn-icon" />Phụ đề
              </button>
              <button id="btn-subtitle-trans" class="transcript-btn" type="button">
                <img src="icons/dichphude.svg" alt="" class="action-btn-icon" />Phiên dịch
              </button>
              <button id="btn-voice" class="transcript-btn" type="button">
                <img src="icons/giongnoi.svg" alt="" class="action-btn-icon" />Giọng nói
              </button>
            </div>
          </div>

          <!-- ✅ HISTORY VIEW (NEW) -->
          <div id="history-content" class="content-view hidden">
            <div class="history-box">
              <div class="history-header">
                <h3>Lịch sử</h3>
                <p class="history-sub">
                <p id="historyUserIdNote" class="history-user-note"></p>
                <div class="history-search-row">
                  <input
                    id="historySearchInput"
                    class="history-search-input"
                    type="search"
                    placeholder="Tìm theo website hoặc nội dung..."
                    autocomplete="off"
                  />
                  <button id="historyRefreshBtn" class="history-refresh-btn" type="button">Làm mới</button>
                </div>
              </div>

              <div class="history-body">
                <div id="historyLoading" class="history-loading hidden">Đang tải lịch sử...</div>
                <div id="historyEmpty" class="history-empty hidden">Chưa có dữ liệu lịch sử.</div>
                <div id="historyList" class="history-list" role="list"></div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ✅ BOTTOM BAR: fixed for ALL features -->
      <div class="bottom-bar">
        <div class="bottom-left">
          <span id="bottomGreeting" class="bottom-greeting">Xin chào</span>
          <button class="login-btn" id="loginLink" type="button">Đăng nhập</button>
        </div>

        <div class="icon-group">
          <button id="icon-btn-gift" class="icon-btn-simple" title="gift" type="button"></button>
          <button id="icon-btn-heart" class="icon-btn-simple" title="heart" type="button"></button>
          <button id="icon-btn-help" class="icon-btn-simple" title="help" type="button"></button>
          <button id="icon-btn-mail" class="icon-btn-simple" title="mail" type="button"></button>
        </div>
      </div>
    </div>

    <!-- ✅ RIGHT: toolbar fixed -->
    <div class="toolbar">
      <div class="toolbar-mini-row">
        <button id="btn-collapse" class="icon-btn mini" title="Thu gọn" type="button"></button>
        <button id="btn-fullscreen" class="icon-btn mini" title="Toàn màn hình" type="button"></button>
      </div>

      <div class="toolbar-item nav-item">
        <button id="btn-transcript" class="icon-btn nav-btn active" data-view="transcript" title="Transcript" type="button"></button>
        <span class="icon-label">Phiên dịch</span>
      </div>

      <div class="toolbar-item nav-item">
        <button id="btn-chat" class="icon-btn nav-btn" data-view="chat" title="Chat" type="button"></button>
        <span class="icon-label">Trợ lý ảo</span>
      </div>

      <div class="toolbar-item nav-item">
        <button id="btn-history" class="icon-btn nav-btn" data-view="history" title="History" type="button"></button>
        <span class="icon-label">Lịch sử</span>
      </div>

      <div class="toolbar-item nav-item">
        <button id="btn-more" class="icon-btn" title="More" type="button"></button>
        <span class="icon-label">Thêm</span>
      </div>

      <div class="toolbar-spacer" aria-hidden="true"></div>

      <div class="toolbar-item toolbar-footer">
        <button id="btn-setting" class="icon-btn" title="Setting" type="button"></button>
      </div>

      <div class="toolbar-item toolbar-footer">
        <button id="btnAccount" class="icon-btn" title="Account" type="button" data-vt-account></button>
      </div>
    </div>
  </div>

  <!-- HISTORY DETAIL MODAL -->
  <div id="historyDetailModal" class="history-modal hidden" aria-hidden="true">
    <div class="history-modal-backdrop" data-history-close="1"></div>
    <div class="history-modal-card" role="dialog" aria-modal="true" aria-label="Chi tiết transcript">
      <button id="historyDetailClose" class="history-modal-close" type="button" aria-label="Đóng">×</button>
      <div class="history-modal-head">
        <h3 id="historyDetailTitle" class="history-modal-title">Chi tiết</h3>
        <p id="historyDetailMeta" class="history-modal-meta"></p>
      </div>
      <pre id="historyDetailContent" class="history-modal-content">Đang tải nội dung...</pre>
      <div class="history-modal-actions">
        <button id="historyDownloadBtn" class="history-download-btn" type="button" disabled>Tải xuống file</button>
      </div>
    </div>
  </div>

  <!-- CHAT RAG PICKER (small popup) -->
  <div id="chatRagPicker" class="rag-picker hidden" aria-hidden="true">
    <div class="rag-picker-header">
      <div class="rag-picker-title-row">
        <h3 class="rag-picker-title">Nguồn thông tin</h3>
        <button id="chatRagPickerClose" class="rag-picker-close" type="button" aria-label="Đóng">×</button>
      </div>
      <div class="rag-picker-search-row">
        <input id="chatRagSearch" class="rag-picker-search" type="search" placeholder="Tìm kiếm..." autocomplete="off" />
        <button id="chatRagPinBtn" class="rag-pin-btn" type="button">Xác nhận</button>
      </div>
    </div>
    <div id="chatRagPickerLoading" class="rag-picker-loading hidden">Đang tải ...</div>
    <div id="chatRagPickerEmpty" class="rag-picker-empty hidden">Chưa có nội dung.</div>
    <div id="chatRagPickerList" class="rag-picker-list" role="list"></div>
  </div>

  <!-- CHAT RAG DETAIL MODAL (large center) -->
  <div id="chatRagDetailModal" class="history-modal hidden" aria-hidden="true">
    <div class="history-modal-backdrop" data-chat-rag-close="1"></div>
    <div class="history-modal-card" role="dialog" aria-modal="true" aria-label="Chi tiết">
      <button id="chatRagDetailClose" class="history-modal-close" type="button" aria-label="Đóng">×</button>
      <div class="history-modal-head">
        <h3 id="chatRagDetailTitle" class="history-modal-title">Chi tiết</h3>
        <p id="chatRagDetailMeta" class="history-modal-meta"></p>
      </div>
      <pre id="chatRagDetailContent" class="history-modal-content">Đang tải nội dung...</pre>
    </div>
  </div>

  <!-- Busy modal -->
  <div id="vtBusyModal" class="vt-busy hidden" role="alertdialog" aria-live="assertive">
    <div class="vt-busy-card">
      <button id="vtBusyClose" class="vt-busy-close" type="button" aria-label="Đóng">×</button>
      <div class="vt-busy-text">Hệ thống đang bận, vui lòng thử lại sau.</div>
      <img src="icons/busy.gif" alt="Đang xử lý" class="vt-busy-img" />
    </div>
  </div>

  <!-- Error modal -->
  <div id="vtErrorModal" class="vt-modal hidden" role="alertdialog" aria-live="assertive">
    <div class="vt-modal-card">
      <button id="vtErrorClose" class="vt-modal-close" type="button" aria-label="Đóng">×</button>
      <div class="vt-modal-text">Đã xảy ra lỗi.</div>
    </div>
  </div>

  <!-- AUTH OVERLAY -->
  <div id="vtAuthOverlay" class="vt-auth-overlay vt-hidden" aria-hidden="true">
    <div id="vtAuthBackdrop" class="vt-auth-backdrop"></div>
    <div class="vt-auth-sheet" role="dialog" aria-modal="true" aria-label="Đăng nhập / Đăng ký">
      <iframe id="vtAuthFrame" class="vt-auth-frame" src="" title="V-Transer Auth" loading="lazy"></iframe>
    </div>
  </div>

  <!-- ACCOUNT MENU -->
  <div id="vtAccountOverlay" class="vt-account-overlay vt-hidden" aria-hidden="true">
    <div id="vtAccountBackdrop" class="vt-account-backdrop"></div>

    <div class="vt-account-popover" role="dialog" aria-modal="false" aria-label="Account">
      <div class="vt-acc-top">
        <div class="vt-acc-avatar">
          <img id="vtAccAvatar" class="vt-acc-avatar-img hidden" alt="" />
          <div id="vtAccAvatarFallback" class="vt-acc-avatar-fallback">U</div>
        </div>

        <div class="vt-acc-title">
          <div class="vt-acc-name-row">
            <div id="vtAccName" class="vt-acc-name">User</div>
            <div id="vtAccPlan" class="vt-acc-pill">Free</div>
          </div>
          <div id="vtAccEmail" class="vt-acc-email">email@example.com</div>
        </div>
      </div>

      <div class="vt-acc-credits">
        <div class="vt-acc-credits-icon" aria-hidden="true"></div>
        <div class="vt-acc-credits-text">
          <div class="vt-acc-credits-title">Hoàn thành nhiệm vụ để</div>
          <div class="vt-acc-credits-sub"><b>Nhận thêm Credits</b></div>
        </div>
      </div>

      <div class="vt-acc-menu">
        <button class="vt-acc-item" data-vt-acc-action="whats_new" type="button">
          <span class="vt-acc-ico vt-acc-ico-news" aria-hidden="true"></span> <span>Tin tức</span>
        </button>
        <button class="vt-acc-item" data-vt-acc-action="rewards" type="button">
          <span class="vt-acc-ico vt-acc-ico-rewards" aria-hidden="true"></span> <span>Trung tâm phần thưởng</span>
        </button>
        <button class="vt-acc-item" data-vt-acc-action="my_account" type="button">
          <span class="vt-acc-ico vt-acc-ico-account" aria-hidden="true"></span> <span>Tài khoản</span>
        </button>
        <button class="vt-acc-item" data-vt-acc-action="my_website" type="button">
          <span class="vt-acc-ico vt-acc-ico-site" aria-hidden="true"></span> <span>Trang</span>
        </button>
        <button class="vt-acc-item" data-vt-acc-action="help" type="button">
          <span class="vt-acc-ico vt-acc-ico-help" aria-hidden="true"></span> <span>Trung tâm hỗ trợ</span>
        </button>
        <button class="vt-acc-item" data-vt-acc-action="feedback" type="button">
          <span class="vt-acc-ico vt-acc-ico-feedback" aria-hidden="true"></span> <span>Đánh giá</span>
        </button>

        <div class="vt-acc-sep"></div>

        <button id="vtAccLogout" class="vt-acc-item vt-acc-logout" type="button">
          <span class="vt-acc-ico vt-acc-ico-logout" aria-hidden="true"></span> <span>Đăng xuất</span>
        </button>
      </div>

      <div class="vt-acc-social">
        <button class="vt-social-btn vt-social-btn-x" type="button" aria-label="X"></button>
        <button class="vt-social-btn vt-social-btn-discord" type="button" aria-label="Discord"></button>
        <button class="vt-social-btn vt-social-btn-youtube" type="button" aria-label="YouTube"></button>
        <button class="vt-social-btn vt-social-btn-linkedin" type="button" aria-label="LinkedIn"></button>
      </div>

      <div id="vtAccToast" class="vt-acc-toast hidden"></div>
    </div>
  </div>

  <!-- MY ACCOUNT (EDIT PROFILE) OVERLAY -->
  <div id="vtProfileOverlay" class="vt-profile-overlay vt-hidden" aria-hidden="true">
    <div id="vtProfileBackdrop" class="vt-profile-backdrop"></div>

    <div class="vt-profile-sheet" role="dialog" aria-modal="true" aria-label="Tài khoản của tôi">
      <div class="vt-profile-header">
        <div class="vt-profile-title">Tài khoản của tôi</div>
        <button id="vtProfileClose" class="vt-profile-close" type="button" aria-label="Đóng">×</button>
      </div>

      <div class="vt-profile-body">
        <div class="vt-profile-avatar-row">
          <div class="vt-profile-avatar">
            <img id="vtProfileAvatar" class="vt-profile-avatar-img hidden" alt="" />
            <div id="vtProfileAvatarFallback" class="vt-profile-avatar-fallback">U</div>
          </div>

          <div class="vt-profile-avatar-actions">
            <label class="vt-profile-file-btn">
              Chọn ảnh
              <input id="vtProfileFile" type="file" accept="image/*" class="hidden" />
            </label>

            <button id="vtProfileRemoveAvatar" class="vt-profile-ghost-btn" type="button">
              Xóa ảnh
            </button>
          </div>
        </div>

        <label class="vt-profile-lbl">Ảnh đại diện</label>
        <input id="vtProfileAvatarUrl" class="vt-profile-inp" type="text" placeholder="https://... hoặc data:image/..." />

        <label class="vt-profile-lbl">Email</label>
        <input id="vtProfileEmail" class="vt-profile-inp" type="text" disabled />

        <label class="vt-profile-lbl">Số điện thoại</label>
        <input id="vtProfilePhone" class="vt-profile-inp" type="text" placeholder="Nhập số điện thoại (tuỳ chọn)" />

        <label class="vt-profile-lbl">Họ và tên</label>
        <input id="vtProfileFullName" class="vt-profile-inp" type="text" placeholder="Nhập tên hiển thị" />

        <div class="vt-profile-actions">
          <button id="vtProfileCancel" class="vt-profile-ghost-btn" type="button">Hủy</button>
          <button id="vtProfileSave" class="vt-profile-primary-btn" type="button" disabled>Lưu</button>
        </div>

        <div id="vtProfileToast" class="vt-profile-toast hidden"></div>
      </div>
    </div>
  </div>

  <script src="auth/config.js"></script>
  <script src="auth/auth_host.js"></script>
  <script src="sidepanel_history.js"></script>
  <script src="sidepanel.js"></script>
</body>
</html>
